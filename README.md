# 视频自动画中画 (Auto Picture-in-Picture)

利用浏览器原生属性与脚本逻辑相结合，实现的极致稳定、简洁的视频自动画中画工具。

## ✨ 核心功能

*   **🚀 自动开启**：切换浏览器标签页（Tab）或切换桌面应用窗口（Blur）时，自动将正在播放的视频转入画中画。
*   **↩️ 自动恢复**：重新回到视频所在页面时，自动退出画中画并恢复原位播放。
*   **⌨️ 快捷键支持**：
    *   `P` 键：手动开启或关闭画中画（支持播放/暂停视频）。
    *   `Q` 键：切换**网页全屏**（视频铺满浏览器窗口）。
*   **🛡️ 运行稳定**：基于 `autoPictureInPicture` 原生属性，解决了传统脚本常见的“手势限制”导致无法触发的问题。

## 💡 使用技巧（必读）

由于浏览器的安全限制，**页面加载后请在页面任意位置点击一次**（授权手势）。
*   只要点过一次，后续的“窗口失焦自动进入”和“P键操作”就会 100% 生效。
*   切换标签页触发受原生支持，不受此限制。

## 🛠 配置说明

脚本内置了简单的配置项（在代码顶部）：
```javascript
const CONFIG = {
    enabled: true,  // 是否启用
    debug: true     // 是否在控制台输出运行日志
};
```

## 🔄 逻辑说明

| 动作 | 自动入 PiP | 自动出 PiP | 说明 |
| :--- | :--- | :--- | :--- |
| **切换标签页** | ✅ 是 | ✅ 是 | 极速响应，由浏览器原生处理 |
| **离开浏览器窗口** | ✅ 是 | ✅ 是 | 需执行过一次页面点击激活 |
| **按 P 键** | ✅ 受控 | ✅ 受控 | 手动模式，支持所有视频状态 |

## 📦 安装方式

在使用本脚本前，请先安装浏览器扩展 [Tampermonkey](https://www.tampermonkey.net/)。

### 方法 A：通过 GreasyFork 安装 (推荐)
1. [点击此处访问 GreasyFork 页面](https://greasyfork.org/zh-CN/scripts/562978-%E8%A7%86%E9%A2%91%E8%87%AA%E5%8A%A8%E7%94%BB%E4%B8%AD%E7%94%BB)。
2. 点击“安装此脚本”按钮即可。

### 方法 B：通过 GitHub 原地址安装
1. [点击此处访问脚本原地址](https://github.com/mankaki/video-auto-pip/raw/refs/heads/main/auto-pip.user.js)。
2. 浏览器通常会自动识别并弹出 Tampermonkey 安装确认页面。
3. 如果没有自动弹出，请手动全选复制页面代码，并在 Tampermonkey 中新建脚本粘贴保存。

## 📜 版本记录
*   **v4.8.2**: 可靠性大幅调优。交互保护策略缩短为 300ms（解决 ALT-TAB 失效），增强 Shadow DOM 监测及 playing 属性守护。
*   **v4.8**: 兼容性大跃进。支持 Shadow DOM 深度扫描、启用 `@allFrames` 穿透 iframe、优化动态加载视频检测。
*   **v4.7**: 引入特定站点(MGTV)兼容性优化。
*   **v4.6**: 网页全屏功能 (Q 键) 及交互防崩溃优化 (1s 冷却)。

## ⚠️ 已知问题
*   **芒果TV (mgtv.com)**：由于该站播放器极重且包含大量统计/广告脚本，若仍有崩溃，请尝试在脚本配置中将 `debug` 设为 `false` 。
*   **iframe 播放器**：v4.8 已支持 iframe，但受浏览器同源策略限制，**自动入 PiP 可能需要在 iframe 内部有过点击手势**。

---
**Enjoy watching!** 🍿
